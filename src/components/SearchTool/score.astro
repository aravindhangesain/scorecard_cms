---
import { getLang } from "../../i18n/useLang";
import modulesen from "../../data/top-perfomers.json";
import moduleszh from "../../data/top-perfomers-ch.json";
import ManufacturerLogo from "./ManufacturerLogo.astro";

const PQP_KEYS = ["TC", "DH", "MSS", "HSS", "PID", "LID", "PAN"];
const flipPowerSymbol = (str) => {
  if (!str) return "";

  // Define the map for the swap
  const map = {
    "&gt;": ">",
    ">": ">",
    "&lt;": "<",
    "<": "<",
  };

  // Use a regex to find any of these keys and replace with the map value
  return str.replace(/&gt;|&lt;|>|</g, (matched) => map[matched]);
};
const PQP_LABELS = {
  en: {
    TC: "Thermal Cycling",
    DH: "Damp Heat",
    MSS: "Mechanical Stress Sequence",
    HSS: "Hail Stress Sequence",
    PID: "PID",
    LID: "LID+LETID",
    PAN: "PAN Performance",
  },
  zh: {
    TC: "热循环",
    DH: "湿热",
    MSS: "机械应力序列",
    HSS: "冰雹应力序列",
    PID: "电位诱导衰减",
    LID: "光致诱导衰减+热辅助光致衰减",
    PAN: "PAN 性能",
  },
};

const lang = getLang(Astro);
const modules = lang === "zh" ? moduleszh : modulesen;
const isZh = lang === "zh";

const CATEGORY_LABELS = {
  en: {
    "Manufacturer Name": "Manufacturer Name",
    "PQP Test": "PQP Test",
    "Module Design": "Module Design",
    "Cell Technology": "Cell Technology",
    "Power Class Range": "Power Class Range",
    "Wafer Size (mm)": "Wafer Size (mm)",
    "Factory Location": "Factory Location",
  },
  zh: {
    "Manufacturer Name": "制造商名称",
    "PQP Test": "PQP 测试",
    "Module Design": "组件设计",
    "Cell Technology": "电池技术",
    "Power Class Range": "功率等级范围",
    "Wafer Size (mm)": "硅片尺寸 (mm)",
    "Factory Location": "工厂地点",
  },
};

const filterCategories = {
  "Manufacturer Name": [...new Set(modules.map((m) => m.manufacturer))].sort(),
  "PQP Test": PQP_KEYS.map((key) => ({
    key,
    label: PQP_LABELS[isZh ? "zh" : "en"][key],
  })),

  "Module Design": [...new Set(modules.map((m) => m.moduleDesign))].sort(),
  "Cell Technology": [...new Set(modules.map((m) => m.cellTech))].sort(),
  "Power Class Range": [
    ...new Set(modules.map((m) => flipPowerSymbol(m.powerRange))),
  ].sort((a, b) => {
    const getFirstNum = (str) => {
      const match = str.match(/\d+/);
      return match ? parseInt(match[0], 10) : 0;
    };

    const numA = getFirstNum(a);
    const numB = getFirstNum(b);

    // 1. If the numbers are different, sort by number (e.g., 380 vs 430)
    if (numA !== numB) {
      return numA - numB;
    }

    // 2. If the numbers are the same (e.g., "<380W" and "380-425W")
    // Force the one with "<" to the top
    if (a.includes("<")) return -1;
    if (b.includes("<")) return 1;

    return 0;
  }),
  "Wafer Size (mm)": [...new Set(modules.map((m) => m.waferSize))].sort(),
  "Factory Location": [...new Set(modules.map((m) => m.factory))].sort(),
};
---

<link
  href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap"
  rel="stylesheet"
/>

<div class="scorecard-app" id="scorecard-root">
  <div class="main-container">
    <div class="top-section">
      <div class="row-filters">
        <button class="filters-btn">{isZh ? "过滤器" : "Filters"}</button>
      </div>

      <div id="filter-actions-wrapper" class="row-chips" style="display: none;">
        <button id="clear-filters" class="clear-btn"
          >{isZh ? "清除筛选" : "Clear Filter"}</button
        >
        <div id="chips-container" class="chips-row"></div>
      </div>

      <div class="row-export">
        <button id="export-csv" class="export-btn"
          >{isZh ? "导出 CSV" : "Export CSV"}</button
        >
      </div>
    </div>
    <div class="layout-body">
      <aside class="sidebar">
        <div class="filter-accordion-container">
          {
            Object.entries(filterCategories).map(([category, options]) => (
              <div class="filter-group">
                <button
                  class={`accordion ${category === "PQP Test" ? "active" : ""}`}
                >
                  {CATEGORY_LABELS[isZh ? "zh" : "en"][category]}
                  <span class="plus-minus">
                    {category === "PQP Test" ? "−" : "+"}
                  </span>
                </button>

                <div class={`panel ${category === "PQP Test" ? "show" : ""}`}>
                  <div class="search-box">
                    <span class="search-icon">
                      <img src="/images/search.svg" alt="DH" />
                    </span>
                    <input
                      type="text"
                      class="category-search"
                      placeholder={`Search ${category}`}
                    />
                  </div>
                  <label class="cb-row select-all">
                    <input
                      type="checkbox"
                      class="group-select-all"
                      data-target={category}
                    />
                    <span>Select All</span>
                  </label>
                  <div class="options-list">
                    {options.map((opt) => {
                      const value = typeof opt === "string" ? opt : opt.key;
                      const label = typeof opt === "string" ? opt : opt.label;

                      return (
                        <label class="cb-row">
                          <input
                            type="checkbox"
                            class="filter-cb"
                            data-category={category}
                            value={value}
                            data-label={label}
                          />

                          <span>{label}</span>
                        </label>
                      );
                    })}
                  </div>
                </div>
              </div>
            ))
          }
        </div>
      </aside>
      <main class="content">
        <div class="table-scroll-container">
          <table id="main-table">
            <thead>
              <tr>
                <th class="sticky-col first-col"
                  >{isZh ? "制造商名称" : "MANUFACTURER"}</th
                >
                <th class="sticky-col second-col"
                  >{isZh ? "型号类型" : "MODEL TYPE"}</th
                >
                <th class="icon-th">
                  <a
                    href="/thermal-cycling/"
                    title="Thermal Cycling"
                    target="_blank"
                  >
                    <img src="/images/TC-icon.svg" alt="TC" />
                  </a>
                </th>
                <th class="icon-th">
                  <a href="/damp-heat/" title="Damp Heat" target="_blank">
                    <img src="/images/DH-icon.svg" alt="DH" />
                  </a>
                </th>
                <th class="icon-th">
                  <a
                    href="/mechanical-stress-sequence/"
                    title="Mechanical Stress Sequence"
                    target="_blank"
                  >
                    <img src="/images/MSS-icon.svg" alt="MSS" />
                  </a>
                </th>
                <th class="icon-th">
                  <a
                    href="/hail-stress-sequence/"
                    title="Hail Stress Sequence"
                    target="_blank"
                  >
                    <img src="/images/HSS-icon.svg" alt="HSS" />
                  </a>
                </th>
                <th class="icon-th">
                  <a href="/pid/" title="PID" target="_blank">
                    <img src="/images/PID-icon.svg" alt="PID" />
                  </a>
                </th>
                <th class="icon-th">
                  <a href="/lidletid/" title="LID" target="_blank">
                    <img src="/images/LIDLETID-icon.svg" alt="LID" />
                  </a>
                </th>
                <th class="icon-th">
                  <a href="/pan-performance/" title="PAN" target="_blank">
                    <img src="/images/PAN-icon.svg" alt="PAN" />
                  </a>
                </th>
                <th>{isZh ? "组件设计" : "MODULE DESIGN"}</th>
                <th>{isZh ? "电池技术" : "CELL"}</th>
                <th>{isZh ? "功率范围" : "POWER RANGE"}</th>
                <th>{isZh ? "硅片尺寸 (mm)" : "WAFER SIZE (MM)"}</th>
                <th>{isZh ? "工厂地点" : "FACTORY LOCATION"}</th>
                <th>{isZh ? "BOM " : "BOM ID"}</th>
              </tr>
            </thead>

            <tbody id="table-body">
              {
                modules.map((m) => (
                  <tr
                    class="module-row"
                    data-manufacturer={m.manufacturer}
                    data-design={m.moduleDesign}
                    data-technology={m.cellTech}
                    data-power={flipPowerSymbol(m.powerRange)}
                    data-wafer={m.waferSize}
                    data-factory={m.factory}
                    data-pqp={JSON.stringify(
                      [
                        m.tc ? "TC" : null,
                        m.dh ? "DH" : null,
                        m.mss ? "MSS" : null,
                        m.hss ? "HSS" : null,
                        m.pid ? "PID" : null,
                        m.lid ? "LID" : null,
                        m.pan ? "PAN" : null,
                      ].filter(Boolean),
                    )}
                  >
                    <td class="sticky-col first-col">
                      <ManufacturerLogo manufacturer={m.manufacturer} />
                    </td>
                    <td class="sticky-col second-col">{m.model}</td>
                    <td class="center-cell">
                      {typeof m.tc === "number" ? (
                        <div class="status-stack">
                          <span class="status-value">{m.tc}</span>
                          <img
                            src="/images/check-icon.svg"
                            class="check-icon-small"
                            alt="✓"
                          />
                        </div>
                      ) : m.tc === "\u2713" ? (
                        <img
                          src="/images/check-icon.svg"
                          class="check-icon"
                          alt="✓"
                        />
                      ) : (
                        <span class="empty-dash" />
                      )}
                    </td>
                    <td class="center-cell">
                      {typeof m.dh === "number" ? (
                        <div class="status-stack">
                          <span class="status-value">{m.dh}</span>
                          <img
                            src="/images/check-icon.svg"
                            class="check-icon-small"
                            alt="✓"
                          />
                        </div>
                      ) : m.dh === "\u2713" ? (
                        <img
                          src="/images/check-icon.svg"
                          class="check-icon"
                          alt="✓"
                        />
                      ) : (
                        <span class="empty-dash" />
                      )}
                    </td>
                    <td class="center-cell">
                      {typeof m.mss === "number" ? (
                        <div class="status-stack">
                          <span class="status-value">{m.mss}</span>
                          <img
                            src="/images/check-icon.svg"
                            class="check-icon-small"
                            alt="✓"
                          />
                        </div>
                      ) : m.mss === "\u2713" ? (
                        <img
                          src="/images/check-icon.svg"
                          class="check-icon"
                          alt="✓"
                        />
                      ) : (
                        <span class="empty-dash" />
                      )}
                    </td>
                    <td class="center-cell">
                      {typeof m.hss === "number" ? (
                        <div class="status-stack">
                          <span class="status-value">{m.hss}</span>
                          <img
                            src="/images/check-icon.svg"
                            class="check-icon-small"
                            alt="✓"
                          />
                        </div>
                      ) : m.hss === "\u2713" ? (
                        <img
                          src="/images/check-icon.svg"
                          class="check-icon"
                          alt="✓"
                        />
                      ) : (
                        <span class="empty-dash" />
                      )}
                    </td>
                    <td class="center-cell">
                      {typeof m.pid === "number" ? (
                        <div class="status-stack">
                          <span class="status-value">{m.pid}</span>
                          <img
                            src="/images/check-icon.svg"
                            class="check-icon-small"
                            alt="✓"
                          />
                        </div>
                      ) : m.pid === "\u2713" ? (
                        <img
                          src="/images/check-icon.svg"
                          class="check-icon"
                          alt="✓"
                        />
                      ) : (
                        <span class="empty-dash" />
                      )}
                    </td>
                    <td class="center-cell">
                      {typeof m.lid === "number" ? (
                        <div class="status-stack">
                          <span class="status-value">{m.lid}</span>
                          <img
                            src="/images/check-icon.svg"
                            class="check-icon-small"
                            alt="✓"
                          />
                        </div>
                      ) : m.lid === "\u2713" ? (
                        <img
                          src="/images/check-icon.svg"
                          class="check-icon"
                          alt="✓"
                        />
                      ) : (
                        <span class="empty-dash" />
                      )}
                    </td>
                    <td class="center-cell">
                      {typeof m.pan === "number" ? (
                        <div class="status-stack">
                          <span class="status-value">{m.pan}</span>
                          <img
                            src="/images/check-icon.svg"
                            class="check-icon-small"
                            alt="✓"
                          />
                        </div>
                      ) : m.pan === "\u2713" ? (
                        <img
                          src="/images/check-icon.svg"
                          class="check-icon"
                          alt="✓"
                        />
                      ) : (
                        <span class="empty-dash" />
                      )}
                    </td>
                    <td>{m.moduleDesign}</td>
                    <td>{m.cellTech}</td>
                    <td>{flipPowerSymbol(m.powerRange)}</td>
                    <td>{m.waferSize}</td>
                    <td>{m.factory}</td>
                    <td>{m.bomId}</td>
                  </tr>
                ))
              }
            </tbody>
          </table>
          <div id="no-results" class="no-results-msg" style="display: none;">
            No Top Performers are found
          </div>
        </div>
        <div id="pagination-container"></div>
      </main>
    </div>
    <div id="custom-cursor" class="custom-cursor">
      <span class="cursor-arrow">‹</span>
      <div class="cursor-circle"></div>
      <span class="cursor-arrow">›</span>
    </div>
  </div>

  <script>
    class ScorecardManager {
      constructor() {
        this.root = document.getElementById("scorecard-root");
        if (!this.root) return;

        this.rows = Array.from(this.root.querySelectorAll(".module-row"));
        this.cbs = this.root.querySelectorAll(".filter-cb");
        this.allCbs = this.root.querySelectorAll(".group-select-all");
        this.currentPage = 1;
        this.pageSize = 10;

        this.iconMap = {
          TC: "/images/TC-icon.svg",
          DH: "/images/DH-icon.svg",
          MSS: "/images/MSS-icon.svg",
          HSS: "/images/HSS-icon.svg",
          PID: "/images/PID-icon.svg",
          LID: "/images/LIDLETID-icon.svg",
          PAN: "/images/PAN-icon.svg",
        };

        this.init();
      }

      // --- CHANGE 1: Update this function to expand Accordion & detect filter ---
      applyPQPFromURL() {
        const params = new URLSearchParams(window.location.search);
        const pqp = params.get("pqp_test");

        if (!pqp) return false; // Return false if no param

        let found = false;
        this.root
          .querySelectorAll('.filter-cb[data-category="PQP Test"]')
          .forEach((cb) => {
            // Check the box if values match
            if (cb.value === pqp) {
               cb.checked = true;
               found = true;

               // EXPAND ACCORDION LOGIC
               const filterGroup = cb.closest(".filter-group");
               if (filterGroup) {
                 const btn = filterGroup.querySelector(".accordion");
                 const panel = filterGroup.querySelector(".panel");
                 const symbol = filterGroup.querySelector(".plus-minus");
                 
                 if (btn) btn.classList.add("active");
                 if (panel) panel.classList.add("show");
                 if (symbol) symbol.textContent = "−";
               }
            }
          });
        
        return found; // Return true if we actually checked a box
      }

      applyManufacturerFromURL() {
        const params = new URLSearchParams(window.location.search);
        const manuf = params.get("manuf_name");

        if (!manuf) return;

        this.root
          .querySelectorAll('.filter-cb[data-category="Manufacturer Name"]')
          .forEach((cb) => {
            cb.checked = cb.value === manuf;
          });
      }

      hasManufacturerInURL() {
        const params = new URLSearchParams(window.location.search);
        return params.has("manuf_name");
      }

      hasPQPInURL() {
        const params = new URLSearchParams(window.location.search);
        return params.has("pqp_test");
      }

      init() {
        // 1. Accordion Logic (Exclusive Expand)
        const accordions = this.root.querySelectorAll(".accordion");
        accordions.forEach((btn) => {
          btn.onclick = () => {
            const panel = btn.nextElementSibling;
            const isCurrentlyOpen = panel.classList.contains("show");

            // Close all panels
            accordions.forEach((otherBtn) => {
              otherBtn.classList.remove("active");
              otherBtn.nextElementSibling.classList.remove("show");
              const pm = otherBtn.querySelector(".plus-minus");
              if (pm) pm.textContent = "+";
            });

            // Toggle clicked
            if (!isCurrentlyOpen) {
              panel.classList.add("show");
              btn.classList.add("active");
              const pm = btn.querySelector(".plus-minus");
              if (pm) pm.textContent = "−";
            }
          };
        });

        // 2. Export CSV Trigger
        const exportBtn = document.getElementById("export-csv");
        if (exportBtn) {
          exportBtn.onclick = () => this.exportToCSV();
        }

        // 3. Search Logic
        this.root.querySelectorAll(".category-search").forEach((input) => {
          input.oninput = (e) => {
            const val = e.target.value.toLowerCase();
            const list = e.target
              .closest(".panel")
              .querySelectorAll(".options-list .cb-row");
            list.forEach((item) => {
              item.style.display = item.textContent.toLowerCase().includes(val)
                ? "flex"
                : "none";
            });
          };
        });

        // 4. Filter Checkboxes
        this.cbs.forEach((cb) => {
          cb.onchange = () => {
            this.currentPage = 1;
            this.update();
          };
        });

        // 5. Select All Logic
        this.allCbs.forEach((all) => {
          all.onchange = (e) => {
            const panel = e.target.closest(".panel");
            panel.querySelectorAll(".filter-cb").forEach((cb) => {
              if (cb.closest(".cb-row").style.display !== "none") {
                cb.checked = e.target.checked;
              }
            });
            this.currentPage = 1;
            this.update(); // Trigger table refresh
          };
        });

        // 6. Default PQP Selections (ONLY if no manufacturer AND no PQP in URL)
        if (!this.hasManufacturerInURL() && !this.hasPQPInURL()) {
          const defaultPQP_KEYS = ["TC", "DH", "MSS", "HSS", "PID", "LID"];

          this.cbs.forEach((cb) => {
            if (
              cb.dataset.category === "PQP Test" &&
              defaultPQP_KEYS.includes(cb.value)
            ) {
              cb.checked = true;
            }
          });
        }

        // 7. Clear Filters
        const clearBtn = document.getElementById("clear-filters");
        if (clearBtn) {
          clearBtn.onclick = () => {
            this.root
              .querySelectorAll('input[type="checkbox"]')
              .forEach((c) => (c.checked = false));
            this.currentPage = 1;
            this.update();
          };
        }

        // --- CHANGE 2: Update Initialization Sequence ---
        this.applyManufacturerFromURL();
        
        // Capture if we applied a PQP filter
        const pqpApplied = this.applyPQPFromURL(); 
        
        this.update();

        // --- CHANGE 3: Add Scroll Logic here ---
        if (pqpApplied) {
            const tableSection = document.querySelector(".table-scroll-container");
            if (tableSection) {
                setTimeout(() => {
                    const yOffset = -100; 
                    const y = tableSection.getBoundingClientRect().top + window.scrollY + yOffset;
                    window.scrollTo({ top: y, behavior: "smooth" });
                }, 200);
            }
        }
      }

      update() {
        const params = new URLSearchParams(window.location.search);
        const manuf = params.get("manuf_name");
        const normalized = manuf?.toLowerCase();

        // Get all manufacturer options
        const manufCbs = Array.from(
          this.root.querySelectorAll(
            '.filter-cb[data-category="Manufacturer Name"]',
          ),
        );

        const exists = manufCbs.some(
          (cb) => cb.value.toLowerCase() === normalized,
        );

        // If URL manufacturer is invalid, show no results
        if (manuf && !exists) {
          this.rows.forEach((row) => (row.dataset.filtered = "false"));
          this.applyPagination();
          this.renderChips();
          this.toggleEmptyState();
          return; // skip normal filtering
        }

        // --- Normal filtering below ---
        const filters = {
          "Manufacturer Name": this.getSelected("Manufacturer Name"),
          "PQP Test": this.getSelected("PQP Test"),
          "Module Design": this.getSelected("Module Design"),
          "Cell Technology": this.getSelected("Cell Technology"),
          "Power Class Range": this.getSelected("Power Class Range"),
          "Wafer Size (mm)": this.getSelected("Wafer Size (mm)"),
          "Factory Location": this.getSelected("Factory Location"),
        };

        this.rows.forEach((row) => {
          const rowPQP = JSON.parse(row.dataset.pqp || "[]");
          const matches = [
            filters["Manufacturer Name"].length === 0 ||
              filters["Manufacturer Name"].includes(row.dataset.manufacturer),
            filters["PQP Test"].length === 0 ||
              filters["PQP Test"].every((f) => rowPQP.includes(f)),
            filters["Module Design"].length === 0 ||
              filters["Module Design"].includes(row.dataset.design),
            filters["Cell Technology"].length === 0 ||
              filters["Cell Technology"].includes(row.dataset.technology),
            filters["Power Class Range"].length === 0 ||
              filters["Power Class Range"].includes(row.dataset.power),
            filters["Wafer Size (mm)"].length === 0 ||
              filters["Wafer Size (mm)"].includes(row.dataset.wafer),
            filters["Factory Location"].length === 0 ||
              filters["Factory Location"].includes(row.dataset.factory),
          ];
          row.dataset.filtered = matches.every(Boolean) ? "true" : "false";
        });

        this.applyPagination();
        this.renderChips();
        this.toggleEmptyState();
      }

      getSelected(cat) {
        return Array.from(
          this.root.querySelectorAll(
            `.filter-cb[data-category="${cat}"]:checked`,
          ),
        ).map((c) => c.value);
      }

      applyPagination() {
        this.rows.forEach((r) => (r.style.display = "none"));
        const filteredRows = this.rows.filter(
          (r) => r.dataset.filtered === "true",
        );
        const start = (this.currentPage - 1) * this.pageSize;
        const end = start + this.pageSize;
        filteredRows.slice(start, end).forEach((r) => (r.style.display = ""));
        this.renderPagination(filteredRows.length);
      }

      renderPagination(total) {
        const container = document.getElementById("pagination-container");
        if (!container) return;

        container.innerHTML = '<div class="pagination-footer"></div>';
        const footer = container.querySelector(".pagination-footer");
        const pages = Math.ceil(total / this.pageSize);
        if (pages <= 0) return;

        // Results per page selector
        const perPageDiv = document.createElement("div");
        perPageDiv.className = "rows-numebr-sec";
        perPageDiv.innerHTML = `
        <span>Results per page</span>
        <select class="row_numeber_change">
          ${[10, 25, 50, 75, 100].map((n) => `<option value="${n}" ${this.pageSize === n ? "selected" : ""}>${n}</option>`).join("")}
        </select>`;

        perPageDiv.querySelector("select").onchange = (e) => {
          this.pageSize = parseInt(e.target.value);
          this.currentPage = 1;
          this.applyPagination();
        };
        footer.appendChild(perPageDiv);

        // Pagination List
        const ul = document.createElement("ul");
        ul.className = "pagination";

        ul.appendChild(
          this.navBtn(
            "Previous",
            this.currentPage === 1,
            () => {
              this.currentPage--;
              this.applyPagination();
            },
            "prev-icon",
          ),
        );

        for (let i = 1; i <= pages; i++) {
          if (i === 1 || i === pages || Math.abs(i - this.currentPage) <= 1) {
            const li = document.createElement("li");
            li.className = i === this.currentPage ? "active" : "";
            li.innerHTML = `<a href="javascript:void(0)">${i}</a>`;
            li.onclick = (e) => {
              e.preventDefault();
              this.currentPage = i;
              this.applyPagination();
            };
            ul.appendChild(li);
          } else if (i === this.currentPage - 2 || i === this.currentPage + 2) {
            const dots = document.createElement("li");
            dots.className = "dots";
            dots.innerHTML = "<span>...</span>";
            ul.appendChild(dots);
          }
        }

        ul.appendChild(
          this.navBtn(
            "Next",
            this.currentPage === pages,
            () => {
              this.currentPage++;
              this.applyPagination();
            },
            "next-icon",
          ),
        );
        footer.appendChild(ul);
      }

      navBtn(text, disabled, fn, extraClass) {
        const li = document.createElement("li");
        li.className = `${extraClass} ${disabled ? "not-active" : ""}`;
        let label = text;
        if (text === "Previous") {
          label = `<span style="margin-right:8px">‹</span> Previous`;
        } else if (text === "Next") {
          label = `Next <span style="margin-left:8px">›</span>`;
        }
        li.innerHTML = `<a href="javascript:void(0)">${label}</a>`;
        if (!disabled)
          li.onclick = (e) => {
            e.preventDefault();
            fn();
          };
        return li;
      }

      renderChips() {
        const container = document.getElementById("chips-container");
        const wrapper = document.getElementById("filter-actions-wrapper");
        if (!container || !wrapper) return;

        container.innerHTML = "";

        const activeCheckboxes = Array.from(this.cbs).filter(
          (cb) => cb.checked,
        );
        wrapper.style.display = activeCheckboxes.length ? "flex" : "none";

        activeCheckboxes.forEach((cb) => {
          const chip = document.createElement("div");
          chip.className = "filter-chip";

          const label = cb.dataset.label || cb.value;
          let iconHtml = "";

          if (cb.dataset.category === "PQP Test") {
            const iconSrc = this.iconMap[cb.value];
            if (iconSrc) {
              iconHtml = `<div class="chip-icon"><img src="${iconSrc}" /></div>`;
            }
          }

          chip.innerHTML = `
      <div class="chip-content">
        ${iconHtml}
        <span class="chip-text">${label}</span>
        <button class="remove-chip">
          <img src="/images/close-icon.svg" class="close-img" />
        </button>
      </div>
    `;

          chip.querySelector(".remove-chip").onclick = () => {
            cb.checked = false;
            this.currentPage = 1;
            this.update();
          };

          container.appendChild(chip);
        });
      }

      exportToCSV() {
        const table = document.getElementById("main-table");
        const rows = Array.from(table.querySelectorAll("tr"));
        const visibleRows = rows.filter(
          (row) =>
            row.parentElement.tagName === "THEAD" ||
            row.dataset.filtered === "true",
        );

        const csvContent = visibleRows
          .map((row) => {
            return Array.from(row.querySelectorAll("th, td"))
              .map((cell) => {
                let data = cell.innerText.replace(/\n/g, " ").trim();
                if (data === "" && cell.querySelector('img[alt="✓"]'))
                  data = "Yes";
                else if (data === "" && cell.classList.contains("center-cell"))
                  data = "No";
                return `"${data.replace(/"/g, '""')}"`;
              })
              .join(",");
          })
          .join("\n");

        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute(
          "download",
          `scorecard-export-${new Date().toISOString().split("T")[0]}.csv`,
        );
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      toggleEmptyState() {
        const visibleRows = this.rows.filter(
          (r) => r.dataset.filtered === "true",
        );
        const noResults = document.getElementById("no-results");
        const table = document.getElementById("main-table");
        if (visibleRows.length === 0) {
          if (noResults) noResults.style.display = "block";
          if (table) table.style.display = "none";
        } else {
          if (noResults) noResults.style.display = "none";
          if (table) table.style.display = "table";
        }
      }
    }

    // --- Initialize Event Listeners ---
    document.addEventListener("DOMContentLoaded", () => {
      new ScorecardManager();

      const cursor = document.getElementById("custom-cursor");
      const tableContainer = document.querySelector(".table-scroll-container");

      // Only run custom cursor/drag if not a touch device
      const isTouch = "ontouchstart" in window || navigator.maxTouchPoints > 0;
      if (!cursor || !tableContainer || isTouch) {
        if (cursor) cursor.style.display = "none";
        return;
      }

      document.addEventListener("mousemove", (e) => {
        cursor.style.left = `${e.clientX}px`;
        cursor.style.top = `${e.clientY}px`;
      });

      tableContainer.addEventListener("mousemove", (e) => {
        const isInTbody = e.target.closest("#table-body");
        cursor.style.display = isInTbody ? "flex" : "none";
      });

      tableContainer.addEventListener("mouseleave", () => {
        cursor.style.display = "none";
      });

      let isDragging = false;
      let dragStartX = 0;
      let scrollStartLeft = 0;

      tableContainer.addEventListener("mousedown", (e) => {
        if (!e.target.closest("#table-body")) return;
        isDragging = true;
        dragStartX = e.clientX;
        scrollStartLeft = tableContainer.scrollLeft;
        tableContainer.classList.add("dragging");
        e.preventDefault();
      });

      document.addEventListener("mousemove", (e) => {
        if (!isDragging) return;
        tableContainer.scrollLeft = scrollStartLeft - (e.clientX - dragStartX);
      });

      document.addEventListener("mouseup", () => {
        isDragging = false;
        tableContainer.classList.remove("dragging");
      });
    });
</script>

  <style>
    /* 1. Root and Container Margins */
    .scorecard-app {
      background-color: #fff;
      width: 100%;
      padding: 60px 0; /* Vertical space for the whole app */
      font-family: "Open Sans", sans-serif;
      display: flex;
      justify-content: center;
    }

    .main-container {
      max-width: 1325px; /* Adjust based on your preferred maximum width */
      margin: 0 auto; /* Centers the whole app */
      padding-left: 24px;
      padding-right: 24px; /* Consistent side padding for everything */
    }

    /* 2. Top Section Rows */
    .top-section {
      margin-bottom: 40px;
    }

    .row-filters {
      margin-bottom: 28px;
    }

    .filters-btn {
      background-color: #072643;
      opacity: 0.6;
      color: #ffffff;
      border: none;
      font-family: "Work Sans", sans-serif;
      font-weight: 400;
      padding: 10px 24px;
      font-size: 16px;
      border-radius: 4px;
      width: 120px;
    }

    .row-chips {
      display: flex;
      align-items: flex-start; /* Aligns "Clear Filter" to top of chips block */
      gap: 20px;
      margin-bottom: 28px;
    }

    .clear-btn {
      color: #e40e20;
      font-size: 16px;
      font-family: "Work Sans", sans-serif;
      font-weight: 400;
      background: none;
      border: none;
      cursor: pointer;
      white-space: nowrap;
      padding-top: 8px; /* Visual alignment with chips */
    }

    .row-export {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 28px;
    }

    /* 3. Layout Body (Sidebar + Content) */
    .layout-body {
      display: flex;
      gap: 40px; /* Space between sidebar and table */
      align-items: flex-start;
    }

    .sidebar {
      flex: 0 0 260px; /* Fixed sidebar width */
      position: sticky;
      top: 20px; /* Keeps sidebar visible on scroll */
    }

    .content {
      flex: 1;
      min-width: 0; /* Prevents table from breaking layout */
    }

    /* 4. Table and Chips UI Refinement */
    :global(.filter-chip) {
      display: inline-flex !important;
      align-items: center !important;
      background-color: #f0f0e0 !important; /* Beige background from screenshot */
      border: 1px solid #dcdcc8 !important;
      padding: 0px 8px !important;
      margin-bottom: 4px;
      border-radius: 2px;
      height: 38px !important;
      font-size: 14px !important;
      font-family: "Work Sans", sans-serif !important;
      font-weight: 400 !important;
      color: #072643 !important;
    }

    :global(.remove-chip) {
      color: #d64343 !important;
      font-size: 18px !important;
      margin-left: 2px !important;
      background: none;
      padding: 0 !important;
      border: none;
      cursor: pointer;
    }

    .table-scroll-container {
      border: 1px solid #edf2f7;
      border-radius: 4px;
      overflow-x: auto;
      width: 100%;
    }

    #main-table {
      border-collapse: collapse;
      table-layout: auto; /* Changed from default or fixed */
      min-width: max-content; /* Ensures table is at least as wide as its headers */
    }

    /* Adjust Sidebar Margin-Top to align with table header */
    .filter-accordion-container {
      margin-top: 0;
    }

    :global(.chips-row) {
      display: flex !important;
      flex-wrap: wrap !important;
      gap: 8px !important;
      width: 100% !important;
    }

    .export-btn {
      border: 1px solid #0054c5;
      color: #0054c5;
      background: #fff;
      padding: 8px 24px;
      border-radius: 2px;
      font-size: 16px;
      cursor: pointer;
      font-family: "Work Sans", sans-serif;
      font-weight: 400;
    }

    :global(.chip-content) {
      display: inline-flex !important;
      align-items: center !important;
      gap: 4px !important;
    }

    /* Chip Icon */
    :global(.chip-icon) {
      width: 16px !important;
      height: 16px !important;
      display: flex !important;
    }

    :global(.chip-icon img) {
      width: 100% !important;
      height: 100% !important;
      object-fit: contain !important;
    }

    /* Chip Text Label */
    :global(.chip-text) {
      font-size: 14px !important;
      color: #1a2b3b !important;
      white-space: nowrap !important;
      line-height: 32px !important;
    }

    .filter-group {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      margin-bottom: 12px;
      overflow: hidden;
      font-family: "Work Sans", sans-serif;
      font-weight: 400;
      font-size: 16px;
      color: #5a5b5e;
    }
    .accordion {
      width: 100%;
      display: flex;
      justify-content: space-between;
      font-family: "Work Sans", sans-serif;
      font-size: 16px;
      font-weight: 400;
      color: #072643;
      padding: 14px 16px;
      border: none;
      background: #fff;
      cursor: pointer;
    }
    /* --- Slide Animation Styles --- */
    .panel {
      max-height: 0; /* Start closed */
      overflow: hidden; /* Hide content */
      opacity: 0; /* Fade out */
      padding: 0 12px; /* Horizontal padding stays, vertical is 0 */
      border-top: 1px solid transparent;
      transition:
        max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1),
        opacity 0.3s ease,
        padding 0.4s ease,
        border-color 0.4s ease;
    }

    /* When the "show" class is added via JS */
    .panel.show {
      max-height: 500px; /* Set to a value larger than your content */
      opacity: 1; /* Fade in */
      padding: 12px; /* Restore vertical padding */
      border-top: 1px solid #e2e8f0;
    }

    /* Optional: Rotate the plus/minus icon slightly */
    .plus-minus {
      transition: transform 0.3s ease;
    }
    .accordion.active .plus-minus {
      transform: rotate(180deg);
    }
    .search-box {
      display: flex;
      align-items: center;
      border: 1px solid #3182ce;
      border-radius: 4px;
      padding: 6px;
      margin-bottom: 10px;
    }
    .category-search {
      border: none;
      outline: none;
      width: 100%;
      font-size: 12px;
      font-family: "Work Sans", sans-serif;
      font-weight: 400;
      font-size: 14px;
      color: #1e1e1e;
    }
    .cb-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 4px;
      font-size: 16px;
      cursor: pointer;
    }

    .sticky-col {
      position: sticky;
      left: 0;
      z-index: 5;
      background: #fff;
    }
    .first-col {
      left: 0;
      min-width: 160px;
    }
    .second-col {
      left: 160px;
      min-width: 160px;
     
    }
    thead th.sticky-col {
      z-index: 10;
      background: #ffffff;
    }
    th {
      padding: 14px 12px;
      font-size: 14px;
      color: #072643;
      text-align: left;
      border-bottom: 1px solid #edf2f7;
      text-transform: uppercase;
      font-family: "Work Sans", sans-serif;
      font-weight: 400;
    }
    td {
      padding: 16px 12px;
      border-bottom: 1px solid #edf2f7;
      font-size: 14px;
      text-align: left;
      color: #072643;
      font-family: "Work Sans", sans-serif;
      font-weight: 400;
    }
    .blue-check {
      color: #3182ce;
      font-weight: 700;
      font-size: 18px;
    }
    .no-results-msg {
      width: 100%;
      text-align: center;
      padding: 60px 0;
      font-size: 16px;
      color: #5a5b5e;
      font-family: "Work Sans", sans-serif;
      font-weight: 400;
    }

    .center-cell {
      text-align: center;
      vertical-align: middle;
    }
    .status-stack {
      display: flex;
      flex-direction: column;
      align-items: center;
      line-height: 1;
    }
    .status-value {
      font-size: 14px;
      color: #005da1;
      font-family: "Work Sans", sans-serif;
      font-weight: 400;
      margin-bottom: -3px; /* Stacks the number tightly on top of the tick */
    }
    .check-icon-small {
      width: 12px;
      height: 12px;
    }
    .check-icon {
      width: 18px;
      height: 18px;
    }

    :global(.pagination-footer) {
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      gap: 40px !important;
      margin-top: 40px !important;
      font-family: "Work Sans", sans-serif !important;
      font-weight: 400 !important;
      font-size: 16px !important;
      color: #343434 !important; /* Gray text color */
    }

    /* 2. Results per page dropdown box */
    :global(.rows-numebr-sec) {
      display: flex !important;
      align-items: center !important;
      gap: 12px !important;
    }

    :global(.row_numeber_change) {
      border: 1px solid #a7a8ac !important;
      border-radius: 4px !important;
      padding: 6px 10px !important;
      background-color: #fafafa !important;
      color: #a7a8ac !important;
      outline: none !important;
      cursor: pointer !important;
      font-family: "Work Sans", sans-serif !important;
      font-weight: 700 !important;
      font-size: 14px !important;
    }

    /* 3. The Navigation List: Removes dots and forces horizontal row */
    :global(.pagination) {
      display: flex !important;
      flex-direction: row !important;
      list-style: none !important; /* This removes the dots */
      padding: 0 !important;
      margin: 0 !important;
      align-items: center !important;
      gap: 8px !important;
    }

    :global(.pagination li) {
      display: flex !important;
    }

    :global(.pagination li a) {
      text-decoration: none !important;
      color: #000000 !important;
      min-width: 32px !important;
      height: 32px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      border-radius: 2px !important;
      font-family: "Work Sans", sans-serif !important;
      font-weight: 400 !important;
      font-size: 16px !important;
    }

    /* 4. ACTIVE STATE: The exact blue box for the current page */
    :global(.pagination li.active a) {
      background-color: #0054c5 !important; /* Exact blue from screenshot */
      color: white !important;
      font-family: "Work Sans", sans-serif !important;
      font-weight: 400;
      font-size: 16px !important;
    }

    /* 5. PREVIOUS/NEXT Styling */
    :global(.pagination li.prev-icon a) {
      color: #5a5b5e !important; /* Light gray for "Previous" */
      width: auto !important;
      padding-right: 15px !important;
      font-family: "Work Sans", sans-serif !important;
      font-weight: 400 !important;
      font-size: 16px !important;
    }

    :global(.pagination li.next-icon a) {
      color: #0054c5 !important; /* Blue for "Next" */
      width: auto !important;
      padding-left: 15px !important;
      font-family: "Work Sans", sans-serif !important;
      font-weight: 400 !important;
      font-size: 16px !important;
    }

    /* 6. The Chevron (>) styling */
    :global(.nav-arrow) {
      margin-left: 8px !important;
      font-size: 18px !important;
      font-weight: bold !important;
      line-height: 1 !important;
    }

    /* Dots (...) styling */
    :global(.pagination li.dots) {
      color: #a0aec0 !important;
      padding: 0 5px !important;
    }

    .options-list {
      /* 32px (row height) * 6 items = 192px */
      max-height: 192px;
      overflow-y: auto;
      overflow-x: hidden;
      padding-right: 4px;
    }

    /* Custom Cursor Styling */
    :global(.custom-cursor) {
      display: none;
      position: fixed;
      align-content: center;
      pointer-events: none;
      z-index: 10000;
      justify-content: center; /* horizontal centering */
      gap: 8px;
      transform: translate(-50%, -50%);
      transition: transform 0.1s ease-out;
    }

    .cursor-circle {
      width: 44px;
      height: 44px;
      border: 1px solid #000;
      border-radius: 50%;
      background: transparent;
      align-items: center;
      justify-content: center;
    }

    .cursor-arrow {
      font-size: 22px;
      line-height: 1; /* prevents vertical misalignment */
      display: flex;
      align-items: center;
      justify-content: center;
      height: 44px; /* match circle height */
      user-select: none;
    }

    /* Hide default mouse pointer only when hovering over the table area */
    #table-body tr,
    #table-body td {
      cursor: none !important;
    }
    thead th,
    .table-scroll-container::-webkit-scrollbar,
    .table-scroll-container::-webkit-scrollbar-thumb {
      cursor: auto !important;
    }

    .table-scroll-container.dragging {
      cursor: grabbing !important;
    }

    .table-scroll-container.dragging * {
      user-select: none !important;
    }

    /* --- RESPONSIVE ADJUSTMENTS (ADD TO BOTTOM OF STYLE) --- */

    /* Tablet & Mobile Screens (Below 1024px) */
    @media (max-width: 1024px) {
      .main-container {
        max-width: 100%;
        padding: 0 20px;
      }

      .layout-body {
        flex-direction: column; /* Stacks Sidebar on top of Table */
        gap: 30px;
      }

      .sidebar {
        flex: none;
        width: 100%;
        position: relative; /* Removes sticky for easier mobile scrolling */
        top: 0;
      }

      .row-chips {
        flex-direction: column; /* Stacks "Clear" above chips if narrow */
        gap: 10px;
      }

      .clear-btn {
        padding-top: 0;
      }

      /* Keep the table scrollable but ensure it doesn't push the screen wide */
      .content {
        width: 100%;
        overflow: hidden;
      }
    }

    /* Mobile Specific (Below 768px) */
    @media (max-width: 768px) {
      .top-section {
        margin-bottom: 20px;
      }

      /* Align Export and Filter buttons for easy thumb access */
      .row-filters,
      .row-export {
        width: 100%;
        justify-content: center;
      }

      .filters-btn {
        width: 120px;
        max-width: none;
      }
      .export-btn {
        width: 100%;
        max-width: none;
      }

      /* Responsive Pagination Footer */
      :global(.pagination-footer) {
        flex-direction: column !important;
        gap: 20px !important;
        text-align: center;
      }

      :global(.pagination) {
        flex-wrap: wrap;
        justify-content: center;
      }

      /* Adjust sticky columns for small screens so they don't eat the whole view */
      .first-col {
        min-width: 100px;
      }
      .second-col {
        left: 100px;
        min-width: 140px;
      }
    }

    /* Disable Custom Cursor on Touch Devices to prevent UI "ghosting" */
    @media (hover: none) {
      :global(.custom-cursor) {
        display: none !important;
      }
      #table-body tr,
      #table-body td {
        cursor: default !important;
      }
    }
    @media (max-width: 480px) {
      .main-container {
        padding-left: 16px;
        padding-right: 16px;
      }
    }

    /* --- FULL FLUID RESPONSIVENESS (ALL RATIOS) --- */

    /* 1. Ensure the container is fluid, not fixed */
    .main-container {
      width: 100%;
      max-width: 1325px;
      margin: 0 auto;
      padding-left: 3%; /* Percentage padding allows for smoother scaling */
      padding-right: 3%;
      box-sizing: border-box;
    }

    .top-section {
      display: flex;
      flex-direction: column;
    }

    /* 3. The Layout Body: The most critical part for resizing */
    @media (max-width: 1100px) {
      .layout-body {
        flex-direction: column; /* Stacks sidebar on top when space is tight */
        gap: 20px;
      }

      .sidebar {
        width: 100%; /* Sidebar takes full width on smaller screens */
        flex: none;
        position: relative; /* Disables sticky only when stacked */
        top: 0;
      }

      .content {
        width: 100%;
      }
    }

    /* 4. Table Scroll Consistency */
    .table-scroll-container {
      width: 100%;
      max-width: 100vw; /* Prevents container from exceeding viewport */
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* 5. Responsive Sticky Columns */
    /* As width reduces, we shrink the sticky columns slightly so they don't block the view */
    @media (max-width: 600px) {
      .first-col {
        min-width: 100px;
      }
      .second-col {
        left: 100px;
        min-width: 130px;
      }

      /* Stack the pagination and row selector */
      :global(.pagination-footer) {
        flex-direction: column !important;
        align-items: center !important;
        gap: 20px !important;
      }
    }

    /* 6. Fix for Chips scaling */
    :global(.chips-row) {
      display: flex !important;
      flex-wrap: wrap !important;
      width: 100% !important;
    }

    /* 7. Button scaling */
    @media (max-width: 480px) {
      .filters-btn,
      .export-btn {
        width: 100%; /* Full width buttons on very narrow screens */
        text-align: center;
      }
    }
  </style>
</div>
