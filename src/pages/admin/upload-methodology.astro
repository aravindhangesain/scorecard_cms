---
/*
  Admin – Upload Methodology JSON
  Calls Python (Flask) backend via Nginx proxy
*/
---

<style>
  .upload-wrapper {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f5f7fa;
    font-family: system-ui, sans-serif;
  }

  .upload-card {
    background: #ffffff;
    padding: 32px;
    width: 360px;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
  }

  .upload-card h1 {
    font-size: 20px;
    margin-bottom: 8px;
  }

  .upload-card p {
    font-size: 14px;
    color: #666;
    margin-bottom: 20px;
  }

  input[type="file"] {
    width: 100%;
    margin-bottom: 16px;
  }

  button {
    width: 100%;
    padding: 10px;
    background: #2563eb;
    color: #fff;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
  }

  button:disabled {
    background: #94a3b8;
    cursor: not-allowed;
  }

  #status {
    margin-top: 12px;
    font-size: 13px;
  }
</style>

<div class="upload-wrapper">
  <div class="upload-card">
    <h1>Upload Methodology</h1>
    <p>Select a JSON file to update methodology data.</p>

    <form id="uploadForm">
      <!-- <input
        type="file"
        name="file"
        accept="application/json"
        required
      /> -->
      <input type="file" name="file" accept=".json,.xlsx,.xls,.csv" required />

      <button type="submit">Upload JSON</button>
      <div id="status"></div>
    </form>
  </div>
</div>
<script>
  const form = document.getElementById("uploadForm");
  const status = document.getElementById("status");
  const button = form.querySelector("button");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const fileInput = form.querySelector('input[type="file"]');
    const file = fileInput.files[0];

    if (!file) {
      status.textContent = "Please select a file";
      return;
    }

    const ext = file.name.split(".").pop().toLowerCase();

    let endpoint = "";

    if (ext === "json") {
      endpoint = "/api/upload-methodology";
    } else if (["xlsx", "xls", "csv"].includes(ext)) {
      endpoint = "/api/upload-top-performers";
    } else {
      status.textContent = "Unsupported file type";
      return;
    }

    status.textContent = "Uploading…";
    button.disabled = true;

    const formData = new FormData();
    formData.append("file", file);

    try {
      const res = await fetch(endpoint, {
        method: "POST",
        body: formData
      });

      const data = await res.json();

      if (res.ok) {
        if (ext === "json") {
          status.textContent =
            `✅ JSON uploaded (archived v${data.archived?.match(/\d+/)?.[0]})`;
        } else {
          status.textContent =
            `✅ ${ext.toUpperCase()} converted successfully`;
        }
        form.reset();
      } else {
        status.textContent = `${data.message || data.error}`;
      }
    } catch (err) {
      status.textContent = "Server not reachable";
    } finally {
      button.disabled = false;
    }
  });
</script>

<!-- <script>
  const form = document.getElementById("uploadForm");
  const status = document.getElementById("status");
  const button = form.querySelector("button");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    status.textContent = "Uploading…";
    button.disabled = true;

    const formData = new FormData(form);

    try {
      const res = await fetch("/api/upload-methodology", {
        method: "POST",
        body: formData,
      });

      // const res = await fetch("http://127.0.0.1:5000/api/upload-methodology", {
      //   method: "POST",
      //   body: formData
      // });

      const data = await res.json();

      if (res.ok) {
        status.textContent = `✅ Upload successful (archived v${data.archived?.match(/\d+/)?.[0]})`;
        form.reset();
      } else {
        status.textContent = `❌ ${data.message || data.error}`;
      }
    } catch (err) {
      status.textContent = "❌ Server not reachable";
    } finally {
      button.disabled = false;
    }
  });
</script> -->